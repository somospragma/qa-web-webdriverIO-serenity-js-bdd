import 'webdriverio';
import { AbsentModalDialog, AcceptedModalDialog, DismissedModalDialog, ModalDialogHandler } from '@serenity-js/web';
import { WebdriverProtocolErrorCode } from './WebdriverProtocolErrorCode.js';
/**
 * WebdriverIO-specific implementation of [`ModalDialogHandler`](https://serenity-js.org/api/web/class/ModalDialogHandler/),
 * used with the [WebDriver protocol](https://webdriver.io/docs/api/webdriver).
 *
 * @group Models
 */
export class WebdriverIOModalDialogHandler extends ModalDialogHandler {
    browser;
    errorHandler;
    defaultHandler = async () => {
        const message = await this.browser.getAlertText();
        await this.browser.dismissAlert();
        this.modalDialog = new DismissedModalDialog(message);
    };
    currentHandler;
    constructor(browser, errorHandler) {
        super();
        this.browser = browser;
        this.errorHandler = errorHandler;
        this.currentHandler = this.defaultHandler;
        this.errorHandler.setHandlerFor(WebdriverProtocolErrorCode.UnexpectedAlertOpenError, error_ => this.tryToHandleDialog());
    }
    async tryToHandleDialog() {
        try {
            await this.currentHandler();
        }
        catch (error) {
            if (error.name === WebdriverProtocolErrorCode.NoSuchAlertError) {
                this.modalDialog = new AbsentModalDialog();
                return;
            }
            throw error;
        }
    }
    async acceptNext() {
        this.currentHandler = async () => {
            const message = await this.browser.getAlertText();
            await this.browser.acceptAlert();
            this.modalDialog = new AcceptedModalDialog(message);
        };
    }
    async acceptNextWithValue(text) {
        this.currentHandler = async () => {
            await this.browser.sendAlertText(String(text));
            const message = await this.browser.getAlertText();
            await this.browser.acceptAlert();
            this.modalDialog = new AcceptedModalDialog(message);
        };
    }
    async dismissNext() {
        this.currentHandler = async () => {
            const message = await this.browser.getAlertText();
            await this.browser.dismissAlert();
            this.modalDialog = new DismissedModalDialog(message);
        };
    }
    async reset() {
        this.modalDialog = new AbsentModalDialog();
        this.currentHandler = this.defaultHandler;
    }
    /**
     * @override
     */
    async last() {
        if (this.modalDialog instanceof AbsentModalDialog) {
            await this.tryToHandleDialog();
        }
        return this.modalDialog;
    }
}
//# sourceMappingURL=WebdriverIOModalDialogHandler.js.map